---
layout: default
title: 04_Настройка OpenVPN Server
---
<a class="back-link" href="index.html">⬅ Назад к списку</a>


##  Настройка OpenVPN Server 

02-06-2023, 10:42 PM

  
**1\. Заходим в SSH консоль шлюза gate**  
  


Код:
    
    
    apt-get update && apt-get install -y iptables-persistent openvpn easy-rsa

Код:
    
    
    mkdir -p /etc/openvpn/easy-rsa

Код:
    
    
    cp -R /usr/share/easy-rsa /etc/openvpn/

Код:
    
    
    cd /etc/openvpn/easy-rsa/

Код:
    
    
    ./easyrsa init-pki

Код:
    
    
    ./easyrsa build-ca

**Вводим пароль!  
Пароль в консоли не отражается!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.39.42.png Просмотров:	0 Размер:	4.5 Кб ID:	1575](images\\img_1575_1684230182.jpg)  
  


Код:
    
    
    12345678

**Вводим свое имя домена!**  
  


Код:
    
    
    kubeadm.ru

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.49.33.png Просмотров:	0 Размер:	5.8 Кб ID:	1576](images\\img_1576_1684230626.jpg)  
  


Код:
    
    
    ./easyrsa gen-dh

**Ждем завершения процесса!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-03-25 в 9.33.17.png Просмотров:	0 Размер:	7.4 Кб ID:	1330](images\\img_1330_1679726079.jpg)  
  


Код:
    
    
    openvpn --genkey --secret ./pki/ta.key

Код:
    
    
    ./easyrsa gen-crl

**Вводим пароль!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.55.44.png Просмотров:	0 Размер:	4.0 Кб ID:	1578](images\\img_1578_1684230985.jpg)  
  


Код:
    
    
    12345678

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.58.05.png Просмотров:	0 Размер:	5.8 Кб ID:	1581](images\\img_1581_1684231139.jpg)  
  


Код:
    
    
    ./easyrsa build-server-full server nopass

**Вводим пароль!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.55.44.png Просмотров:	0 Размер:	4.0 Кб ID:	1579](images\\img_1579_1684230985.jpg)  
  


Код:
    
    
    12345678

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.57.00.png Просмотров:	0 Размер:	8.0 Кб ID:	1580](images\\img_1580_1684231063.jpg)  
  
  


Код:
    
    
    cp ./pki/ca.crt /etc/openvpn/ca.crt
    cp ./pki/dh.pem /etc/openvpn/dh.pem
    cp ./pki/crl.pem /etc/openvpn/crl.pem
    cp ./pki/ta.key /etc/openvpn/ta.key
    cp ./pki/issued/server.crt /etc/openvpn/server.crt
    cp ./pki/private/server.key /etc/openvpn/server.key

Код:
    
    
    zcat /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | sudo tee /etc/openvpn/server.conf

Приведем в соответствие  
  


Код:
    
    
    nano /etc/openvpn/server.conf

Сравниваем и приводим в соответствие  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.15.53.png Просмотров:	0 Размер:	8.6 Кб ID:	1583](images\\img_1583_1684232188.jpg)  
  


Код:
    
    
    server 10.10.0.0 255.255.255.0

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2025-03-11 в 8.59.38.png Просмотров:	0 Размер:	18.8 Кб ID:	4721](images\\img_4721_1741672825.jpg)  
  


Код:
    
    
    push "route 20.20.20.0 255.255.255.0"
    push "route 30.30.30.0 255.255.255.0"

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2025-03-11 в 9.58.34.png Просмотров:	0 Размер:	19.3 Кб ID:	4729](images\\img_4729_1741676350.jpg)  
  
Отключим редирект "всего" трафика через "vpn" туннель  
  
![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2025-03-11 в 9.06.33.png

Просмотров:	12

Размер:	22.0 Кб

ID:	4730](images\\img_4730_1741673272.jpg)  
  


Код:
    
    
    push "dhcp-option DNS 1.1.1.1"
    push "dhcp-option DNS 1.1.2.2"

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2025-03-11 в 8.38.41.png Просмотров:	0 Размер:	19.7 Кб ID:	4717](images\\img_4717_1741671581.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.13.44.png Просмотров:	0 Размер:	8.5 Кб ID:	1582](images\\img_1582_1684232092.jpg)  
  
**2\. Проверим**  
  


Код:
    
    
    systemctl start openvpn@server

  


Код:
    
    
    tail -f /var/log/openvpn/openvpn.log

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-03-25 в 9.52.58.png Просмотров:	0 Размер:	58.6 Кб ID:	1331](images\\img_1331_1679727268.jpg)  
  
[Ctrl]+[C]  
  
**3\. Настроим выход в Интернет**  
  
**!!! Определим имя интерфейса с публичным IP !!!**  
  


Код:
    
    
    ens18 - ISP (интернет)
    ens19 - local network

Код:
    
    
    iptables -I FORWARD -i tun0 -o ens18 -j ACCEPT
    iptables -I FORWARD -i ens18 -o tun0 -j ACCEPT
    iptables-save > /etc/iptables/rules.v4

**4\. Настраиваем клиента**  
  
**my-user1** \- логин первого пользователя, имя произвольное  
  


Код:
    
    
    cd /etc/openvpn/easy-rsa/

Код:
    
    
    ./easyrsa build-client-full **my-user1** nopass

**Вводим пароль!**  
  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 12.55.44.png Просмотров:	0 Размер:	4.0 Кб ID:	1589](images\\img_1589_1684230985.jpg)  
  


Код:
    
    
    12345678

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.28.40.png Просмотров:	0 Размер:	7.7 Кб ID:	1590](images\\img_1590_1684232971.jpg)  
  


Код:
    
    
    mkdir -p /etc/openvpn/clients/**my-user1**

Код:
    
    
    cd /etc/openvpn/clients/**my-user1**

Код:
    
    
    cp /etc/openvpn/easy-rsa/pki/ca.crt ./
    cp /etc/openvpn/easy-rsa/pki/ta.key ./
    cp /etc/openvpn/easy-rsa/pki/issued/**my-user1.crt** ./
    cp /etc/openvpn/easy-rsa/pki/private/**my-user1.key** ./

Код:
    
    
    cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf **.****/my-user1.conf**

Проверим содержимое директории  
  


Код:
    
    
    ls

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.32.01.png Просмотров:	0 Размер:	7.1 Кб ID:	1591](images\\img_1591_1684233226.jpg)  
  
Помотрим свой публичный ip  
  


Код:
    
    
    ip -br a

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2025-03-07 в 12.16.47.png Просмотров:	0 Размер:	25.4 Кб ID:	4707](images\\img_4707_1741339189.jpg)  
  
**xxx.xxx.xxx.xxx** \- заменим своим публичный ip адресом  
  


Код:
    
    
    nano **my-user1.conf**

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.39.40.png Просмотров:	0 Размер:	10.7 Кб ID:	1592](images\\img_1592_1684233640.jpg)  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.41.14.png Просмотров:	0 Размер:	13.8 Кб ID:	1593](images\\img_1593_1684233760.jpg)  
  


Код:
    
    
    cp **my-user1.conf my-user1.ovpn**

Создаем архив с ключами пользователя **my-user1**  
  


Код:
    
    
    cd ..

Код:
    
    
    tar -cf **my-user1.tar**./**my-user1**

Проверим содержимое директории  
  


Код:
    
    
    ls

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-05-16 в 13.44.02.png Просмотров:	3 Размер:	9.9 Кб ID:	1594](images\\img_1594_1684233906.jpg)  
  
**5\. Отключаем SSH (по желанию)**  
  


Код:
    
    
    systemctl stop ssh

Код:
    
    
    systemctl disable ssh

**6\. Перегружаем**  
  


Код:
    
    
    reboot

  
**Поздравляю, настройка завершена!**

Вложения 

  * [ ![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2023-05-16 в 12.55.44.png

Просмотров:	226

Размер:	4.0 Кб

ID:	1588](images\\img_1588_0.jpg) ](filedata/fetch?id=1588)
  * [ ![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2023-05-16 в 12.49.33.png

Просмотров:	220

Размер:	5.8 Кб

ID:	1587](images\\img_1587_0.jpg) ](filedata/fetch?id=1587)
  * [ ![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2023-05-16 в 12.49.33.png

Просмотров:	222

Размер:	5.8 Кб

ID:	1586](images\\img_1586_0.jpg) ](filedata/fetch?id=1586)
  * [ ![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2023-05-16 в 12.49.33.png

Просмотров:	228

Размер:	5.8 Кб

ID:	1585](images\\img_1585_0.jpg) ](filedata/fetch?id=1585)
  * [ ![Нажмите на изображение для увеличения.



Название:	image_1170.png

Просмотров:	224

Размер:	5.8 Кб

ID:	1577](images\\img_1577_0.jpg) ](filedata/fetch?id=1577)




---

