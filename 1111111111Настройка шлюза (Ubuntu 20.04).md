# Объявление

## Anonymous (Unknown date)

* * *

[#1 ](https://forum.kubeadm.ru/node/3741#post3741)

##  Настройка шлюза (Ubuntu 20.04) 

06-29-2024, 04:04 AM

vCPU = 4  
vRAM = 4 Gb  
vHDD = 40 Gb  
  
**1\. Подготовим 1 виртуальную машину**  
  


Код:
    
    
    gate

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 19.57.59.png Просмотров:	0 Размер:	12.1 Кб ID:	3994](images\\img_3994_1728147521.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 19.59.12.png Просмотров:	0 Размер:	20.7 Кб ID:	3995](images\\img_3995_1728147607.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.00.21.png Просмотров:	0 Размер:	24.4 Кб ID:	3996](images\\img_3996_1728147662.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.01.28.png Просмотров:	0 Размер:	25.5 Кб ID:	3997](images\\img_3997_1728147751.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.02.48.png Просмотров:	0 Размер:	10.4 Кб ID:	3998](images\\img_3998_1728147819.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.03.56.png Просмотров:	0 Размер:	11.0 Кб ID:	3999](images\\img_3999_1728147874.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.05.42.png Просмотров:	0 Размер:	21.2 Кб ID:	4000](images\\img_4000_1728148015.jpg)  
  
**2\. Добавляем 2-й сетевой интерфейс**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.23.26.png Просмотров:	0 Размер:	68.4 Кб ID:	4004](images\\img_4004_1728149076.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.24.54.png Просмотров:	0 Размер:	17.2 Кб ID:	4005](images\\img_4005_1728149168.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.26.19.png Просмотров:	0 Размер:	64.7 Кб ID:	4006](images\\img_4006_1728149236.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.08.31.png Просмотров:	0 Размер:	26.9 Кб ID:	4001](images\\img_4001_1728148163.jpg)  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 20.10.13.png Просмотров:	0 Размер:	30.1 Кб ID:	4002](images\\img_4002_1728148360.jpg)  
  
**3\. Установка Ubuntu 20.04 LTS**  
  
**Инструкция _[тут](https://forum.kubeadm.ru/node/397)_ **  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 21.42.56.png Просмотров:	0 Размер:	11.5 Кб ID:	4007](images\\img_4007_1728154034.jpg)  
  
**!!! IP адреса у вас свои !!!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-05 в 21.49.22.png Просмотров:	0 Размер:	4.1 Кб ID:	4008](images\\img_4008_1728154248.jpg)  
  
**4\. Назначим пароль на учетную запись root**  
  
Заходим по SSH  
  


Код:
    
    
    sudo passwd root

Переключаемся в режим root  
  


Код:
    
    
    su

Код:
    
    
    cd

**5\. Назначаем IP адрес на 2-й сетевой интерфейс**  
  


Код:
    
    
    nano /etc/netplan/01-netcfg.yaml

**!!! Добавляем секцию соблюдая отступы !!!**  
  


Код:
    
    
        ens19:
           addresses: [ 20.20.20.1/24 ]

![Нажмите на изображение для увеличения.  Название:	image_3111.png Просмотров:	7 Размер:	35.5 Кб ID:	4242](images\\img_4242_1732433775.jpg)  
  


Код:
    
    
    netplan apply

Проверим  
  


Код:
    
    
    ip a

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-06 в 6.28.31.png Просмотров:	0 Размер:	69.9 Кб ID:	4019](images\\img_4019_1728185396.jpg)  
  
**6\. Устанавливаем доп.пакеты**  
  


Код:
    
    
    apt-get update -y && apt-get install -y qemu-guest-agent iptables-persistent net-tools wget openssh-server nano mc

Выбираем "Да"  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2025-01-12 в 12.52.06.png Просмотров:	0 Размер:	30.3 Кб ID:	4434](images\\img_4434_1736675574.jpg)  
  
**7\. Отключаем локальный DNS на клиенте**  
  


Код:
    
    
    systemctl stop systemd-resolved && systemctl disable systemd-resolved

Код:
    
    
    rm /etc/resolv.conf && nano /etc/resolv.conf

Код:
    
    
    nameserver 1.1.1.1
    nameserver 1.1.2.2

Проверим  
  


Код:
    
    
    nslookup mail.ru

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-06-29 в 7.22.46.png Просмотров:	0 Размер:	29.2 Кб ID:	3765](images\\img_3765_1719635004.jpg)  
  
**8\. Отключим Firewall**  
  


Код:
    
    
    systemctl stop ufw && systemctl disable ufw

  
**9\. Включим маршрутизацию**  
  


Код:
    
    
    nano /etc/sysctl.conf

Ищем строку и удаляем комментарий в начале строки  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-06-29 в 7.24.01.png Просмотров:	0 Размер:	41.4 Кб ID:	3766](images\\img_3766_1719635091.jpg)  
  
Применим настройку  
  


Код:
    
    
    sysctl -p

**10\. Открываем порты 80 и 443**  
  


Код:
    
    
    ens18 - ISP (интернет)
    ens19 - local network

Код:
    
    
    apt-get update && apt-get install -y iptables-persistent

Port 80|443  
  


Код:
    
    
    iptables -A FORWARD -i ens18 -o ens19 -p tcp --syn --dport 80 -m conntrack --ctstate NEW -j ACCEPT
    iptables -A FORWARD -i ens18 -o ens19 -p tcp --syn --dport 443 -m conntrack --ctstate NEW -j ACCEPT
    iptables -A FORWARD -i ens18 -o ens19 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    iptables -A FORWARD -i ens19 -o ens18 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

Translate 80|443  
  


Код:
    
    
    20.20.20.77 metallb_pool

Код:
    
    
    iptables -t nat -A PREROUTING -i ens18 -p tcp --dport 80 -j DNAT --to-destination 20.20.20.77
    iptables -t nat -A PREROUTING -i ens18 -p tcp --dport 443 -j DNAT --to-destination 20.20.20.77

Код:
    
    
    iptables-save > /etc/iptables/rules.v4

**11\. Автозагрузка правил**  
  


Код:
    
    
    nano /root/autostart-iptables.sh

Код:
    
    
    #!/bin/sh
    
    /sbin/iptables-restore < /etc/iptables/rules.v4

Код:
    
    
    chmod +x /root/autostart-iptables.sh

Код:
    
    
    nano /etc/systemd/system/autostart-iptables.service

Код:
    
    
    [Unit]
    Description=This script runs at system startup
    After=network.target
    
    [Service]
    Type=oneshot
    ExecStart=/bin/bash /root/autostart-iptables.sh
    
    [Install]
    WantedBy=multi-user.target

Код:
    
    
    systemctl daemon-reload

Код:
    
    
    systemctl enable autostart-iptables

**12\. Добавим правило для Firewall**  
  


Код:
    
    
    iptables -t nat -A POSTROUTING -j MASQUERADE

Код:
    
    
    iptables-save > /etc/iptables/rules.v4

**13\. Перегружаем**  
  


Код:
    
    
    reboot

  
**Поздравляю, настройка завершена!**


---

