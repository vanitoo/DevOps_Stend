---
layout: default
title: 14_Настройка S3 API Ceph 15 Octopus (Ubuntu 20.04)
---
<a class="back-link" href="index.html">⬅ Назад к списку</a>


##  Настройка S3 API Ceph 15 Octopus (Ubuntu 20.04) 


  
**Подготовим 3 виртуальных машин**  
  
Клонируем шаблон k8s-UbuntuTemplate  
  
3 - ceph ноды  
  
vCPU = 4  
vRAM = 4 Gb  
vHDD = 40 Gb  
vHDD = 100 Gb  
  
**!!! Добавляем диск !!!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 11.26.31.png Просмотров:	0 Размер:	64.1 Кб ID:	4154](..\images\\img_4154_1731400053.png)  
  
Меняем IP и имена хостов на каждом узле  
  


Код:
    
    
    rm /etc/resolv.conf && nano /etc/resolv.conf

Код:
    
    
    nameserver 20.20.20.2

Код:
    
    
    nano /etc/netplan/01-netcfg.yaml

Код:
    
    
    20.20.20.20

Код:
    
    
    nano /etc/hostname

Код:
    
    
    ceph01

Код:
    
    
    reboot

**!!! ceph02 и ceph03 настраиваем аналогично !!!**  
  
**1\. Добавим имена хостов на все ноды**  
  


Код:
    
    
    rm /etc/hosts && nano /etc/hosts

Код:
    
    
    127.0.0.1       localhost
    ::1     localhost
    #
    20.20.20.20 ceph01
    20.20.20.21 ceph02
    20.20.20.22 ceph03
    #

**2\. Установка доп. пакетов (на всех нодах)**  
  


Код:
    
    
    apt-get update && apt-get install -y cephadm chrony

Код:
    
    
    cephadm install ceph-common

**3\. Откроем доступ root по SSH (на всех нодах)**  
  


Код:
    
    
    nano /etc/ssh/sshd_config

Код:
    
    
    PermitRootLogin yes

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-10-27 в 13.52.55.png Просмотров:	0 Размер:	15.7 Кб ID:	2798](..\images\\img_2798_1698404012.png)  
  


Код:
    
    
    systemctl restart sshd

**4\. Далее выполняем настройку с ceph01**  
  


Код:
    
    
    cephadm bootstrap --mon-ip 20.20.20.20 --allow-fqdn-hostname

**!!! Сохраним username password и fsid из консоли !!!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 6.41.15.png Просмотров:	0 Размер:	38.6 Кб ID:	2120](..\images\\img_2120_1690083843.png)  
  
**5\. Подключаем 2 и 3 ноды:**  
  
**Все команды выполняем с ceph01:**  
  


Код:
    
    
    ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph01

Код:
    
    
    ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph02

Код:
    
    
    ssh-copy-id -f -i /etc/ceph/ceph.pub root@ceph03

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 10.52.46.png Просмотров:	0 Размер:	3.6 Кб ID:	2126](..\images\\img_2126_1690098872.png)  
  


Код:
    
    
    ceph orch host add ceph01

Код:
    
    
    ceph orch host add ceph02

Код:
    
    
    ceph orch host add ceph03

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 10.48.29.png Просмотров:	0 Размер:	13.4 Кб ID:	2124](..\images\\img_2124_1690098606.png)  
  
**6\. Настройка сети:**  
  
**Все команды выполняем с ceph01**  
  


Код:
    
    
    ceph config set mon public_network 20.20.20.0/24

Разворачиваем мониторы:  
  


Код:
    
    
    ceph orch apply mon "ceph01,ceph02,ceph03"

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 10.50.52.png Просмотров:	0 Размер:	9.0 Кб ID:	2125](..\images\\img_2125_1690098723.png)  
  


Код:
    
    
    ceph orch daemon reconfig mon.ceph01

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 10.55.22.png Просмотров:	3 Размер:	6.9 Кб ID:	2127](..\images\\img_2127_1690098959.png)  
  
Проверка:  
  


Код:
    
    
    ceph orch host ls

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 10.56.33.png Просмотров:	2 Размер:	9.9 Кб ID:	2128](..\images\\img_2128_1690099088.png)  
  
**7\. Создаем OSD:**  
  
**Все команды выполняем с ceph01:**  
  
Убедимся в наличии диска /dev/**sdb**  
  


Код:
    
    
    lsblk

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.00.45.png Просмотров:	0 Размер:	14.5 Кб ID:	4155](..\images\\img_4155_1731402138.png)  
  


Код:
    
    
    ceph orch daemon add osd ceph01:/dev/**sdb**

Код:
    
    
    ceph orch daemon add osd ceph02:/dev/**sdb**

Код:
    
    
    ceph orch daemon add osd ceph03:/dev/**sdb**

​  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.03.52.png Просмотров:	0 Размер:	18.3 Кб ID:	4156](..\images\\img_4156_1731402274.png)  
  
**8\. Проверка**  
  


Код:
    
    
    ceph status

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-13 в 12.42.43.png Просмотров:	0 Размер:	39.2 Кб ID:	4120](..\images\\img_4120_1728812668.png)  
  


Код:
    
    
    ceph osd df

​![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-13 в 12.44.57.png Просмотров:	0 Размер:	29.6 Кб ID:	4121](..\images\\img_4121_1728812773.png)  
  
**9\. Создание пула данных**  
  
**Все команды выполняем с ceph01:**  
  


Код:
    
    
    ceph osd pool create kube-pool 8 8

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 11.04.31.png Просмотров:	2 Размер:	6.7 Кб ID:	2133](..\images\\img_2133_1690099524.png)  
  


Код:
    
    
    ceph osd pool application enable kube-pool rbd

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 11.05.37.png Просмотров:	2 Размер:	10.0 Кб ID:	2134](..\images\\img_2134_1690099591.png)  
  


Код:
    
    
    rbd pool init kube-pool

Создаём пользователя 'kube-user':  
  


Код:
    
    
    ceph auth get-or-create client.kube-user mon 'profile rbd' osd 'profile rbd pool=kube-pool' mgr 'profile rbd pool=kube-pool'

**Записываем свой токен - это пример!**  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 11.07.57.png Просмотров:	2 Размер:	16.3 Кб ID:	2135](..\images\\img_2135_1690099728.png)  
  
* Повторно поcмотреть ID пользователя:  
  


Код:
    
    
    ceph auth get-key client.kube-user

Посмотреть FSID хранилища:  
  


Код:
    
    
    ceph mon dump

**10\. Проверка:**  
  


Код:
    
    
    ceph osd lspools

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-07-23 в 11.10.43.png Просмотров:	2 Размер:	8.4 Кб ID:	2137](..\images\\img_2137_1690099890.png)  
  
**11\. Добавим имена хостов на свой ПК**  
  
**для MacOS**  
  


Код:
    
    
    sudo nano /private/etc/hosts

**для Linux**  
  


Код:
    
    
    nano /etc/hosts

**для Windows**  
  


Код:
    
    
    C:\Windows\System32\drivers\etc\hosts

**!!! Имя домена вводим свое !!!**  
  


Код:
    
    
    #CEPH
    20.20.20.20 ceph01
    20.20.20.21 ceph02
    20.20.20.22 ceph03

**12\. Откроем веб интерфейс**  
  


Код:
    
    
    https://ceph01:8443/

Код:
    
    
    login: admin
    password: из консоли

  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-01-30 в 7.02.44.png Просмотров:	0 Размер:	245.2 Кб ID:	461](..\images\\img_461_1643515459.png)​  
  
**![Нажмите на изображение для увеличения.  Название:	экрана 2022-01-30 в 7.04.55.png Просмотров:	0 Размер:	227.6 Кб ID:	462](..\images\\img_462_1643515537.png)​  
  
13\. Мониторинг**  
  
Prometeus Alert Manager  
  
**![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.37.15.png Просмотров:	4 Размер:	47.2 Кб ID:	926](..\images\\img_926_1649475743.png)​**  
  
Prometeus  
  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.35.14.png Просмотров:	4 Размер:	95.5 Кб ID:	927](..\images\\img_927_1649475801.png)​  
  
Grafana  
  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.38.30.png Просмотров:	4 Размер:	71.9 Кб ID:	928](..\images\\img_928_1649475846.png)​  
  
  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.45.35.png Просмотров:	4 Размер:	62.2 Кб ID:	929](..\images\\img_929_1649476001.png)​  
  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.47.00.png Просмотров:	4 Размер:	72.4 Кб ID:	930](..\images\\img_930_1649476060.png)​  
  
![Нажмите на изображение для увеличения.  Название:	экрана 2022-04-09 в 6.48.41.png Просмотров:	4 Размер:	82.0 Кб ID:	931](..\images\\img_931_1649476189.png)​  
  
  
**14\. Добавим поддержку S3 API**  
  
**Все команды выполняем с ceph01**  
  
**!!! Имя домена у вас свои !!!**  
  


Код:
    
    
    ceph orch apply rgw **s3.kubeadm.ru** default --placement="3 ceph01 ceph02 ceph03" --port=8000

**!!! Ждем 5-10 минут !!!**  
  
Проверим  
  


Код:
    
    
    ceph -s

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-08-16 в 15.43.44.png Просмотров:	0 Размер:	53.2 Кб ID:	2473](..\images\\img_2473_1692189958.png)  
  


Код:
    
    
    ceph osd lspools

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-08-16 в 15.46.39.png Просмотров:	0 Размер:	13.4 Кб ID:	2474](..\images\\img_2474_1692190041.png)  
  
Добавляем пользователя  
  


Код:
    
    
    radosgw-admin user create --uid=admin --display-name=admin --system

Копируем содержимое консоли  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.15.16.png Просмотров:	0 Размер:	16.6 Кб ID:	4157](..\images\\img_4157_1731403157.png)  
  


Код:
    
    
    nano access_key

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.23.47.png Просмотров:	0 Размер:	5.0 Кб ID:	4160](..\images\\img_4160_1731403540.png)  
  


Код:
    
    
    nano secret_key

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.25.54.png Просмотров:	0 Размер:	7.0 Кб ID:	4161](..\images\\img_4161_1731403580.png)  
  


Код:
    
    
    ceph dashboard set-rgw-api-access-key -i access_key

Код:
    
    
    ceph dashboard set-rgw-api-secret-key -i secret_key

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 12.27.05.png Просмотров:	0 Размер:	20.8 Кб ID:	4162](..\images\\img_4162_1731403693.png)  
  
  
![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2023-08-16 в 16.05.07.png Просмотров:	0 Размер:	41.2 Кб ID:	2478](..\images\\img_2478_1692191172.png)  
  
**15\. Создадим Buckets**  
  


Код:
    
    
    my-test

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-10-14 в 13.06.13.png Просмотров:	0 Размер:	46.5 Кб ID:	4122](..\images\\img_4122_1728900569.png)  
  
  
**16\. Добавим в файл host на своём ПК**  
  
**для MacOS:**  
  


Код:
    
    
    sudo nano /private/etc/hosts

**для Windows:**  
  


Код:
    
    
    C:\Windows\System32\drivers\etc\hosts

**!!! Имя домена у вас своё !!!**  
  


Код:
    
    
    #CEPH S3 API
    20.20.20.20 s3.kubeadm.ru
    20.20.20.21 s3.kubeadm.ru
    20.20.20.22 s3.kubeadm.ru

**17\. Получим ключи**  
  
**!!! Ключи у вас свои !!!**  
  
Заходим в консоль ceph01  
  


Код:
    
    
    cat access_key

Код:
    
    
    cat secret_key

**18\. Клиенты S3**  
  
**Для MacOS**  
  
**Commander One**  
  


Код:
    
    
    https://mac.eltima.com/commander-one-download.html

Код:
    
    
    CEPH S3 API

Код:
    
    
    http://s3.kubeadm.ru:8000

![Нажмите на изображение для увеличения.  Название:	Снимок экрана 2024-11-12 в 14.23.25.png Просмотров:	2 Размер:	42.1 Кб ID:	4163](..\images\\img_4163_1731411146.png)  
  
**Для Windows**  
  
**S3 Browser**  
  


Код:
    
    
    https://s3browser.com/

![Нажмите на изображение для увеличения.  Название:	79.png Просмотров:	0 Размер:	130.6 Кб ID:	2526](..\images\\img_2526_1692868455.png)  
  
Создадим bucket, загрузим файлы  
  
![Нажмите на изображение для увеличения.  Название:	81.png Просмотров:	0 Размер:	130.2 Кб ID:	2518](..\images\\img_2518_1692860683.png)  
  
Проверим  
  
![Нажмите на изображение для увеличения.  Название:	82.png Просмотров:	0 Размер:	56.3 Кб ID:	2519](..\images\\img_2519_1692860850.png)  
  
Для Windows  
  
[WinSCP](https://winscp.net/eng/download.php)  
  
![Нажмите на изображение для увеличения.  Название:	84.png Просмотров:	0 Размер:	41.4 Кб ID:	2527](..\images\\img_2527_1692868594.png)  
  
![Нажмите на изображение для увеличения.  Название:	85.png Просмотров:	0 Размер:	37.6 Кб ID:	2523](..\images\\img_2523_1692864522.png)  
  
**Поздравляю настройка завершена!**  
  
  
**Сброс пароля**  
  
В водим в консоли ceph01  
  


Код:
    
    
    echo -n "ваш новый пароль" > dashboard-password

Код:
    
    
    ceph dashboard ac-user-set-password admin -i dashboard-password

Вложения 

  * [ ![Нажмите на изображение для увеличения.



Название:	Снимок экрана 2023-03-08 в 22.29.43.png

Просмотров:	285

Размер:	39.4 Кб

ID:	1313](..\images\\img_1313_0.png) ](filedata/fetch?id=1313)




---

